<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="https://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Albums</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="_csrf" content="${_csrf.token}"/>
    <!--    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" media="all" th:href="@{/css/bootstrap.min.css}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dosis:wght@300;400;500&family=Sora:wght@100;200;300;400;500;600;700&display=swap" rel="stylesheet">
    <script defer src="../static/css/fontawesome-5.15.4-web/js/all.js"></script>
    <script defer src="../static/css/fontawesome-5.15.4-web/js/brands.js.js"></script>
    <script defer src="../static/css/fontawesome-5.15.4-web/js/solid.js.js"></script>
    <link rel="stylesheet" href="../static/css/fontawesome-5.15.4-web/css/all.css" th:href="@{/css/fontawesome-5.15.4-web/css/all.css}">
    <link rel="stylesheet" href="../static/css/fontawesome-5.15.4-web/css/fontawesome.css" th:href="@{/css/fontawesome-5.15.4-web/css/fontawesome.css}">
    <link rel="stylesheet" href="../static/css/fontawesome-5.15.4-web/css/brands.css" th:href="@{/css/fontawesome-5.15.4-web/css/brands.css}">
    <link rel="stylesheet" href="../static/css/fontawesome-5.15.4-web/css/solid.css" th:href="@{/css/fontawesome-5.15.4-web/css/solid.css}">
    <link rel="stylesheet" type="text/css" href="../static/css/home.css"  th:href="@{/css/home.css}">
    <script src="../static/js/home.js"></script>
    <script
            src="https://code.jquery.com/jquery-3.6.0.js"
            integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk="
            crossorigin="anonymous"></script>
</head>
<body onload="document.body.style.opacity='1'">

<div class="pre-upload-image-modal" id="create-album-modal">
    <div class="pre-upload-image-modal-content" id="pre-upload-content">
        <div class="pre-upload-image-wrapper">
            <img id="pre-upload-image" th:src="@{/images/album.jpg}" src="../static/images/album.jpg" alt=""/>
        </div>
        <div class="pre-upload-image-details create-album-details-wrapper">
<!--            th:object="${albumModel}" th:action="@{/albums/create-album}"-->
<!--            th:field="*{albumId}"-->
<!--            th:field="*{albumName}"-->
            <form id="album-create-form-title">
                <input type="hidden" name="albumId" id="album-id">
                <h3>Title</h3>
                <input type="text" name="albumName" id="album-name" placeholder="Album name" required>
                <div class="album-create-btns">
                    <button type="button" class="home-title-bar-buttons" id="album-create-form-title-next">
                        Next
                    </button>
                </div>
            </form>

            <form id="album-create-form-images" enctype="multipart/form-data">
<!--                <input type="hidden" name="albumId">-->
                <h3>Select Images</h3>
                <p class="paragraph-color">Select images you want to add right now</p>
<!--                <input type="text" name="added_images" placeholder="Album images" required>-->
                <div class="album-image-select-buttons-container">
                    <button type="button" class="edit-cred-btn placeholder-create-btn" id="album-create-gallery-select">Select from gallery</button>
<!--                    <button type="button" class="edit-cred-btn placeholder-create-btn">Select from gallery</button>-->
                    <input type="hidden" name="imageId" id="image-id">
                        <div>
                            <label class="edit-cred-btn placeholder-create-btn" for="uploaded_image_to_album"><i class="fas fa-upload"></i>&nbsp;&nbsp;Browse computer</label>
                            <input style="display: none" type="file" multiple accept="image/*" class="form-control-file" id="uploaded_image_to_album" name="uploaded_image[]">
<!--                            <input type="hidden" name="imageComment" id="imageComment">-->
                            <!--                                <button class="home-title-bar-buttons" type="submit">Upload</button>-->
                        </div>
                </div>
                <div id="album-create-selected-images-preview-container"></div>
                <div class="album-create-btns">
                    <button type="button" class="home-title-bar-buttons" id="album-create-form-images-back">
                        Back
                    </button>
                    <button type="button" class="home-title-bar-buttons" id="album-create-form-images-next">
                        Next
                    </button>
                </div>
            </form>

<!--            th:object="${albumModel}" th:action="@{/albums/create-album}"-->
<!--            th:field="*{albumComment}"-->
            <form id="album-create-form-comment">
                <!--                <input type="hidden" name="albumId">-->
                <h3>Add Comment</h3>
                <input type="text" name="albumComment" id="album-comment" placeholder="What's so special about this album?" required>
                <div class="album-create-btns">
                    <button type="button" class="home-title-bar-buttons" id="album-create-form-comment-back">
                        Back
                    </button>
                    <button type="button" class="home-title-bar-buttons" id="album-create-form-comment-next">
                        Next
                    </button>
                </div>
            </form>

            <form id="album-create-form-access-type">
<!--                <input type="hidden" name="albumId">-->
                <h3>Access type</h3>
<!--                <input type="text" name="albumAccessType" placeholder="Album access type" required>-->
                <select id="accessType">
                    <option
                            th:each="type : ${accessTypes}"
                            th:value="${type}"
                            th:text="${type}"
                    >
                    </option>
                </select>
                <div class="album-create-btns">
                    <button type="button" class="home-title-bar-buttons" id="album-create-form-access-type-back">
                        Back
                    </button>
                    <button type="submit" class="home-title-bar-buttons" id="album-create-form-access-type-submit">
                        Create album
                    </button>
                </div>
            </form>

            <div class="form-steps">
                <div id="progress-step"></div>
                <div class="step"><p>Title</p></div>
                <div class="step"><p>Images</p></div>
                <div class="step"><p>Comment</p></div>
                <div class="step"><p>Access type</p></div>
            </div>
<!--            <h6>File name</h6>-->
<!--            <p id="pre-upload-image-title"></p>-->
<!--            <h6>Extension</h6>-->
<!--            <p id="pre-upload-image-extension"></p>-->
<!--            <h6>File size</h6>-->
<!--            <p id="pre-upload-image-size"></p>-->
<!--            <form action="#">-->
<!--                <label for="image-comment"><h6>Comment</h6></label>-->
<!--                <br>-->
<!--                <textarea id="image-comment" name="image-comment" rows="2" cols="50" placeholder="Type comment...">-->

<!--                    </textarea>-->
<!--            </form>-->
<!--            <br>-->
<!--            <h6>Tag friends</h6>-->
<!--            <br>-->
<!--            <div class="profile-buttons-container">-->
<!--                <button type="button" class="profile-buttons edit-cred-btn" style="padding: 10px 25px;" onclick="uploadFile('uploaded_image','image-upload-form')">Save</button>-->
<!--                <button type="button" class="profile-buttons" onclick="closeWindow('pre-upload-image-modal')">Close</button>-->
<!--            </div>-->
        </div>
    </div>
</div>

<div id="album-create-select-gallery-images-container">
    <div th:unless="${#lists.size(images) == 0}" id="album-create-gallery-images">
        <div id="album-create-gallery-image-wrapper" th:each="img : ${images}">
            <img class="display-image" th:src="@{${'/home/image/' + img.getImageId()}}" alt="">
        </div>
    </div>
</div>

<div class="content">
    <div class="side-nav">
        <div class="side-nav-title">
            <h2>Albums</h2>
        </div>
        <div class="nav-user-info">
            <div class="image-outer-area-top-bar">
                <div class="image-inner-area-top-bar">
                    <img th:if="${user.getUser_image() != null}" class="profile-image"
                         th:src="@{'/profile/getUserProfileImg'}" alt="Profile image">
                    <img th:unless="${user.getUser_image() != null}" class="profile-image"
                         src="../static/images/default_profile_pic.png" th:src="@{/images/default_profile_pic.png}" alt="Profile image">
                </div>
            </div>
            <div class="nav-user-details">
                <p class="nav-greeting">Hello <span th:text="${user.firstname}"></span></p>
                <p class="nav-user-id-color">User #<span class="nav-user-id" th:text="${user.id}"></span></p>
            </div>
        </div>
        <ul>
            <li><a th:href="@{/home}"><i class="far fa-images side-nav-icons"></i>Photos</a></li>
            <li><a th:href="@{/albums}"><i class="far fa-folder-open side-nav-icons"></i>Albums</a></li>
            <li><a href="#"><i class="fas fa-share-alt-square side-nav-icons"></i>Received files</a></li>
            <li><a th:href="@{/friends}"><i class="fas fa-user-friends side-nav-icons"></i>Friends</a></li>
            <li><a th:href="@{/people}"><i class="fas fa-users side-nav-icons"></i>People</a></li>
            <li><a th:href="@{/profile}"><i class="far fa-address-card side-nav-icons"></i>Profile</a></li>
        </ul>
    </div>
    <div class="main-content">
        <div class="home-title-bar sticky-top">
            <div id="home-title-bar-menu">
<!--                <form action="#" th:action="@{/home/upload-image}" th:object="${imageModel}" enctype="multipart/form-data" method="POST">-->
<!--                    <input type="hidden" name="imageId" id="image-id" th:field="*{imageId}">-->
<!--                    <div class="home-title-bar-options">-->
<!--                        <div>-->
<!--                            <label class="home-title-bar-buttons" for="uploaded_image">Choose image</label>-->
<!--                            <input style="display: none" type="file" accept="image/*" class="form-control-file" id="uploaded_image" name="uploaded_image" th:field="*{uploaded_image}">-->
<!--                            <button class="home-title-bar-buttons" type="submit">Upload</button>-->
<!--                        </div>-->
<!--                    </div>-->
<!--                </form>-->
                <div class="home-title-bar-options">
                    <button type="button" class="home-title-bar-buttons album-create-btns-nav"><i class="fas fa-plus-circle icons"></i>&nbsp;&nbsp;Create album</button>
                </div>
                <form action="#" th:action="@{/logout}" method="POST">
                    <button class="home-title-bar-buttons edit-cred-btn" type="submit" id="logout-btn">Logout</button>
                </form>
            </div>
        </div>
        <div class="main-content-placeholder" th:if="${#lists.size(albums)==0}">
            <i class="far fa-images fa-3x placeholder-icon"></i>
            <p>You don't have any albums</p>
            <button type="button" class="edit-cred-btn placeholder-create-btn album-create-btns-nav">Create album</button>
        </div>
        <div class="title-outer-container" th:unless="${#lists.size(albums) == 0}">
            <div class="user-list-title">
                <h4 th:text="${user.getFirstname() + ' albums'}">Users albums</h4>
            </div>
        </div>
        <div th:unless="${#lists.size(albums) == 0}" class="outer-container-for-images">
            <div th:each="album : ${albums}">
                <h5 th:text="${'ALBUM NAME' + album.getName()}"></h5>
                <h5 th:text="${'DATE CREATED' + album.getDateCreated()}"></h5>
                <h5 th:text="${'COMMENT' + album.getComment()}"></h5>
            </div>
        </div>

    </div>
</div>

<script src="../static/js/jquery-3.6.0.js" th:src="@{/js/jquery-3.6.0.js}"></script>


<script>

    const album_create_gallery_preview_bg = document.getElementById("album-create-select-gallery-images-container");
    const album_create_gallery_open = document.getElementById("album-create-gallery-select");
    const album_create_gallery_images = document.getElementById("album-create-gallery-images");

    album_create_gallery_open.addEventListener('click', function (){
        album_create_gallery_preview_bg.style.display = "flex";
        album_create_gallery_images.style.display = "flex";
    })

    const images_selected_during_album_create = document.getElementById("uploaded_image_to_album");
    const album_create_images_preview_container = document.getElementById("album-create-selected-images-preview-container")

    images_selected_during_album_create.addEventListener('change', function (event){
        let fragment = document.createDocumentFragment();
        for(i = 0;i < event.target.files.length;i++){
            let img_container = document.createElement('div');
            let img = document.createElement('img');
            img.className = 'album-image-preview';
            img_container.className = 'album-image-preview-container';
            img_container.appendChild(img);
            img.src = URL.createObjectURL(event.target.files[i]);
            fragment.appendChild(img_container);
        }
        album_create_images_preview_container.style.display = "flex";
        album_create_images_preview_container.appendChild(fragment);
    })

    const create_album_top_nav = document.getElementsByClassName("album-create-btns-nav")[0];
    const create_album_placeholder = document.getElementsByClassName("album-create-btns-nav")[1];
    const create_album_modal = document.getElementById("create-album-modal");

    create_album_top_nav.addEventListener('click', function (){
        create_album_modal.style.display = "flex";
    })

    create_album_placeholder.addEventListener('click', function (){
        create_album_modal.style.display = "flex";
    })

    window.onclick = function(event) {
        if (event.target === create_album_modal) {
            // album_create_images_preview_container.style.display = "none";
            create_album_modal.style.display = "none";
        }
        if(event.target === album_create_gallery_preview_bg){
            album_create_gallery_preview_bg.style.display = "none";
            album_create_gallery_images.style.display = "none";
        }
    }

    const form_title = document.getElementById("album-create-form-title");
    const form_images = document.getElementById("album-create-form-images");
    const form_comment = document.getElementById("album-create-form-comment");
    const form_access_type = document.getElementById("album-create-form-access-type");

    const form_title_next = document.getElementById("album-create-form-title-next");
    const form_images_back = document.getElementById("album-create-form-images-back");
    const form_images_next = document.getElementById("album-create-form-images-next");
    const form_comment_back = document.getElementById("album-create-form-comment-back");
    const form_comment_next = document.getElementById("album-create-form-comment-next");
    const form_access_type_back = document.getElementById("album-create-form-access-type-back");
    const form_access_type_submit = document.getElementById("album-create-form-access-type-submit");

    // function createAlbum(){
    //     const album_name = document.getElementById("album-name").value;
    //     const album_comment = document.getElementById("album-comment").value;
    //     const album_id = document.getElementById("album-id").value;
    //
    //      const album = {
    //         'albumId' : album_id,
    //         'albumName' : album_name,
    //         'albumComment' : album_comment
    //     }
    // }

    function getAlbumName(event){
        event.preventDefault();

        const formData = new FormData(event.target);
        const name = formData.get('albumName');
        const comment = formData.get('albumComment');
        // alert("CLICKED")
        console.log({name});
        console.log({comment});
    }

    function getAlbumComment(event){
        event.preventDefault();

        const formData = new FormData(event.target);
        const comment = formData.get('albumComment');

        console.log({comment});
    }

    // form_title.addEventListener('submit', getAlbumName);

    const progress_step = document.getElementById("progress-step");

    form_title_next.addEventListener('click', function (){
        form_title.style.left = "-700px";
        form_images.style.left = "20px";
        progress_step.style.width = "50%";
    })

    form_images_back.addEventListener('click', function (){
        form_title.style.left = "20px";
        form_images.style.left = "700px";
        progress_step.style.width = "25%";
    })

    form_images_next.addEventListener('click', function (){
        form_images.style.left = "-700px";
        form_comment.style.left = "20px";
        progress_step.style.width = "75%";
    })

    form_comment_back.addEventListener('click', function (){
        form_images.style.left = "20px";
        form_comment.style.left = "700px";
        progress_step.style.width = "50%";
    })

    form_comment_next.addEventListener('click',function (){
        form_comment.style.left = "-700px";
        form_access_type.style.left = "20px";
        progress_step.style.width = "100%";
    })

    form_access_type_back.addEventListener('click', function (){
        form_comment.style.left = "20px";
        form_access_type.style.left = "700px";
        progress_step.style.width = "75%";
    })

    form_access_type_submit.addEventListener('click',function (event){
        // for(let i = 0;i < document.forms.length; i++){
        //     document.forms[0].submit();
        //     document.forms[2].submit();
        //     event.preventDefault();
        // }

        const id = document.getElementById("album-id");
        const name = document.getElementById("album-name");
        const comment = document.getElementById("album-comment");
        const accessType = document.getElementById("accessType");
        const images = document.getElementById("uploaded_image_to_album").files;
        console.log('IMAGES ' + images.length);

        event.preventDefault();


        let albumImages = [];

        let image = {};
        let albumImagesFormData = new FormData();


        // for(let i = 0;i < images.length;i++){
        //     albumImagesFormData.append('images[' + i + ']',images[i]);
        //     // image = {
        //     //     'image_name' : images[i].name,
        //     //     'content_type' : images[i].type,
        //     //     'image_size' : images[i].size,
        //     //     'comment' : ''
        //     // }
        //
        //     //albumImages.push(image);
        // }


        const i = id.value;
        const n = name.value;
        const c = comment.value;
        const acc = accessType.value;


        // document.forms[0].submit();
        // event.preventDefault();
        // document.forms[2].submit();
        // event.preventDefault();

        // let albumImagesFormData = new FormData();

        let AlbumModel = [];

        // let form1 = document.forms[0];
        // let formData1 = new FormData(form1);
        // let formValues1 = formData1.entries();
        //
        // let form2 = document.forms[2];
        // let formData2 = new FormData(form2);
        // let formValues2 = formData2.entries();

        // a.append('albumName', formValues1.next().value[0]);
        // a.append('albumComment', formValues2.next().value[0]);

        // AlbumModel = {
        //     'albumId' : '',
        //     'albumName' : n,
        //     'albumComment': c,
        //     'albumAccessType' : acc
        // }

        AlbumModel.push({
                'albumName' : n,
                'albumComment': c,
                'albumAccessType' : acc
        })

        albumImagesFormData.append('albumInfo', JSON.stringify(AlbumModel));
        let obj = []

        for(let i = 0;i < images.length;i++){
            albumImagesFormData.append('uploaded_image[' + i + ']',images[i]);
            // image = {
            //     'image_name' : images[i].name,
            //     'content_type' : images[i].type,
            //     'image_size' : images[i].size,
            //     'comment' : ''
            // }

            //albumImages.push(image);
        }
        //albumImagesFormData.append('image', images[0]);

        for (let pair of albumImagesFormData.entries()) {
            console.log(pair[0]+ ', ' + pair[1]);
        }

        const token = $("meta[name='_csrf']").attr("content");

        // $.ajax({
        //     type: "POST",
        //     contentType : "application/json",
        //     url: '/albums/create-album',//do not put the full url,you need use an absolute url
        //     data: JSON.stringify(AlbumModel),
        //     headers: {"X-CSRF-TOKEN" : token},
        //     dataType: 'application/json',
        //     success: function () {
        //         alert("Album created successfully");
        //     }
        //     });
        //
        //     $.ajax({
        //         url: url,
        //         type:"POST",
        //         processData:false,
        //         contentType: false,
        //         data: formData,
        //         complete: function(data){
        //             alert("success");
        //         }
        //     });

            $.ajax({
                type: "POST",
                url: '/albums/create-album',//do not put the full url,you need use an absolute url
                enctype: 'multipart/form-data',
                processData: false,
                contentType: false,
                data: albumImagesFormData,
                headers: {"X-CSRF-TOKEN" : token},
                success: function () {
                    window.location.reload();
                    //alert("Album created successfully");
                }
            });


        // $.ajax({
        //     type: "POST",
        //     url: '/albums/create-album',//do not put the full url,you need use an absolute url
        //     enctype: 'multipart/form-data',
        //     processData: false,
        //     contentType: false,
        //     data: albumImagesFormData,
        //     headers: {"X-CSRF-TOKEN" : token},
        //     success: function () {
        //         alert("Album created successfully");
        //     }
        // });

        // $.ajax({
        //     type: "POST",
        //     enctype: 'multipart/form-data',
        //     headers: { "X-CSRF-TOKEN": token },
        //     data: albumImagesFormData,
        //     processData: false,
        //     contentType: false,
        //     success: function () {
        //         alert("Album created successfully");
        //     }
        // });

        // username.innerHTML = "a";
        // pw.innerHTML = "1";

        // console.log(a);
        // console.log(JSON.stringify(albumImages));
        //
        // Creating a XHR object
        // let xhrReq = new XMLHttpRequest();
        // let endpoint = "/albums/create-album";
        //
        // //open a connection
        // xhrReq.open("POST", endpoint);
        //
        // // Set the request header i.e. which type of content you are sending
        // xhrReq.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
        //
        // // Create a state change callback
        // // xhrReq.onreadystatechange = function (){
        // //     if(xhrReq.readyState === 4 && xhrReq.status === 200){
        // //         // Print received data from server
        // //         // result.innerHTML = this.responseText;
        // //     }
        // // };
        //
        // const dataToSend = JSON.stringify(AlbumModel);
        // console.log(dataToSend);
        // xhrReq.send(dataToSend);

        // for(let i = 0;i < document.forms.length;i++){
        //     let form = document.forms[i];
        //     let formData = new FormData(form);
        //     let formValues = formData.entries();
        //
        //     a.append('albumName', formValues.next().value[0]);
        //     a.append('albumImage', formValues.next().value[1]);
        //     a.append('albumComment', formValues.next().value[2]);
        //     a.append('albumAccessType', formValues.next().value[3]);
        // }

        // form_title.submit();
        // form_comment.submit();
        // getAlbumName(event);
        // // getAlbumComment(event);
    })

</script>
</body>
</html>